<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberCore | Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .swipe-track { background: #e2e8f0; height: 60px; border-radius: 30px; position: relative; padding: 5px; cursor: pointer; }
        .swipe-handle { 
            width: 50px; height: 50px; background: white; border-radius: 25px; 
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: absolute; left: 5px; transition: transform 0.1s ease-out; z-index: 10;
        }
        .swipe-text { position: absolute; width: 100%; text-align: center; line-height: 50px; font-weight: 900; font-size: 10px; color: #94a3b8; pointer-events: none; text-transform: uppercase; letter-spacing: 1px; }
        .glow-green { box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); border-color: #22c55e !important; }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); border-color: #ef4444 !important; }
        .modal-blur { backdrop-filter: blur(12px); background: rgba(0,0,0,0.6); }
        .plan-card.active { border-color: #2563eb; background: #eff6ff; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div id="loginSection" class="w-full max-w-sm bg-white p-8 rounded-[2.5rem] shadow-2xl border border-gray-100">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-black text-gray-800 tracking-tighter italic">CYBER<span class="text-blue-600">CORE</span></h1>
            <p id="systemStatus" class="text-[9px] font-black text-blue-500 uppercase tracking-[0.3em] mt-2">Neural Access Terminal</p>
        </div>

        <div class="space-y-6">
            <div id="inputBorder" class="border-2 border-gray-100 p-1 rounded-3xl transition-all duration-500">
                <input type="number" id="mobileInput" placeholder="Enter Identification" 
                       class="w-full p-4 rounded-2xl outline-none font-mono text-center text-lg bg-transparent">
            </div>

            <div class="swipe-track" id="swipeTrack">
                <div class="swipe-text">Swipe to Authorize</div>
                <div class="swipe-handle" id="swipeHandle">
                    <i class="fa-solid fa-chevron-right text-gray-400"></i>
                </div>
            </div>
        </div>
        <p id="statusMsg" class="text-center mt-6 text-[10px] font-black uppercase tracking-widest text-gray-400"></p>
    </div>

    <div id="paymentModal" class="hidden fixed inset-0 z-50 modal-blur flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[3rem] shadow-2xl overflow-y-auto max-h-[90vh] animate-in zoom-in duration-300">
            <div class="p-8 text-center border-b border-gray-50 sticky top-0 bg-white z-10">
                <h2 class="text-xl font-black italic uppercase tracking-tighter mb-1">Access <span class="text-blue-600">Denied</span></h2>
                <p id="modalSubText" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Select a plan to initialize subscription</p>
            </div>
            
            <div class="p-8 space-y-6">
                <div id="plansContainer" class="grid grid-cols-2 gap-3">
                    <p class="text-center col-span-2 text-xs text-gray-400">Fetching available plans...</p>
                </div>

                <div class="bg-gray-50 p-6 rounded-[2.5rem] flex flex-col items-center border-2 border-dashed border-gray-200">
                    <div id="qrPlaceholder" class="bg-white p-3 rounded-2xl shadow-sm mb-4">
                        <img id="adminQR" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=Waiting" class="w-40 h-40">
                    </div>
                    <p class="text-[9px] font-black text-gray-400 uppercase">Scan to Pay via UPI</p>
                </div>
                
                <input type="text" id="utrInput" placeholder="Enter 12-Digit UTR Number" 
                       class="w-full p-4 bg-gray-50 border border-gray-200 rounded-2xl text-center font-mono text-sm outline-none focus:border-blue-500 transition-all">
                
                <div class="flex flex-col space-y-3">
                    <button onclick="submitPayment()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-xs tracking-widest shadow-xl shadow-blue-200 active:scale-95 transition">
                        Submit Activation Request
                    </button>
                    <button onclick="closeModal()" class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Return to Gateway</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAfrFpzw2UddAxGrhAlIeP_c1OaoIG6wNk",
            authDomain: "in-app-update-21c61.firebaseapp.com",
            databaseURL: "https://in-app-update-21c61-default-rtdb.firebaseio.com",
            projectId: "in-app-update-21c61",
            storageBucket: "in-app-update-21c61.firebasestorage.app",
            messagingSenderId: "1013483026768",
            appId: "1:1013483026768:web:c5f54060842f9672431455"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let selectedPlan = null;
        let adminUPI = "";

        // --- ADMIN SETTINGS SYNC (UPI & PLANS) ---
        function syncAdminSettings() {
            // Get UPI and generate QR
            db.ref('adminSettings/upiId').on('value', s => {
                adminUPI = s.val() || "example@upi";
                updateQR("0"); // Default QR
            });

            // Get Dynamic Plans
            db.ref('plans').on('value', snap => {
                const container = document.getElementById('plansContainer');
                container.innerHTML = "";
                snap.forEach(child => {
                    const plan = child.val();
                    container.innerHTML += `
                        <div onclick="selectPlan('${plan.price}', '${plan.name}', this)" 
                             class="plan-card border-2 border-gray-100 p-4 rounded-3xl cursor-pointer hover:border-blue-200 transition-all text-center">
                            <p class="text-[8px] font-black text-gray-400 uppercase">${plan.name}</p>
                            <p class="text-lg font-black text-gray-800">â‚¹${plan.price}</p>
                        </div>
                    `;
                });
            });
        }

        function updateQR(amount) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=${adminUPI}&pn=CyberCore&am=${amount}&cu=INR`;
            document.getElementById('adminQR').src = qrUrl;
        }

        function selectPlan(price, name, el) {
            selectedPlan = { price, name };
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            updateQR(price);
        }

        // --- SWIPE LOGIC ---
        const handle = document.getElementById('swipeHandle');
        const track = document.getElementById('swipeTrack');
        let isDragging = false;

        handle.addEventListener('touchstart', () => isDragging = true);
        handle.addEventListener('mousedown', () => isDragging = true);
        window.addEventListener('mousemove', (e) => { if(isDragging) move(e.clientX); });
        window.addEventListener('touchmove', (e) => { if(isDragging) move(e.touches[0].clientX); });
        window.addEventListener('mouseup', endMove);
        window.addEventListener('touchend', endMove);

        function move(clientX) {
            let rect = track.getBoundingClientRect();
            let x = clientX - rect.left - 25;
            let maxX = rect.width - 60;
            if (x < 5) x = 5;
            if (x > maxX) { x = maxX; if(isDragging) { isDragging = false; processAccess(); } }
            handle.style.transform = `translateX(${x}px)`;
        }

        function endMove() { if(!isDragging) return; isDragging = false; handle.style.transform = `translateX(5px)`; }

        // --- AUTHENTICATION ENGINE ---
        async function processAccess() {
            const mobile = document.getElementById('mobileInput').value;
            if(mobile.length < 10) {
                alert("Invalid Identification ID");
                handle.style.transform = `translateX(5px)`;
                return;
            }

            db.ref('users/' + mobile).once('value', snap => {
                const user = snap.val();
                if(user) {
                    const now = Date.now();
                    const expiry = user.expiryDate || 0;

                    if(user.status === "Approved" && expiry > now) {
                        localStorage.setItem("loggedInUser", mobile);
                        window.location.href = "dashboard.html";
                    } else if(user.status === "Banned") {
                        showPaymentPopup("ACCESS REVOKED: You don't have a plan. Buy and start.");
                    } else if(user.status === "Pending") {
                        alert("Your request is already under verification.");
                        location.reload();
                    } else {
                        showPaymentPopup("EXPIRED: You don't have an active plan. Buy to start.");
                    }
                } else {
                    showPaymentPopup("NO PLAN: You haven't purchased any plan yet.");
                }
            });
        }

        function showPaymentPopup(msg) {
            document.getElementById('modalSubText').innerText = msg;
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            handle.style.transform = `translateX(5px)`;
        }

        function submitPayment() {
            const utr = document.getElementById('utrInput').value;
            const mobile = document.getElementById('mobileInput').value;
            if(!selectedPlan) return alert("Please select a plan first.");
            if(utr.length < 10) return alert("Invalid UTR. Enter 12-digit code.");

            db.ref('users/' + mobile).set({
                mobile: mobile,
                utr: utr,
                selectedPlan: selectedPlan.name,
                requestedAmount: selectedPlan.price,
                status: "Pending",
                timestamp: Date.now(),
                expiryDate: 0 // Reset or stay 0 until admin approves
            }).then(() => {
                alert("Activation Request Sent. Admin will verify your UTR.");
                location.reload();
            });
        }

        syncAdminSettings();
    </script>
</body>
</html>
